name: Build Side Quests

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build macOS App
    runs-on: macos-latest

    env:
      SCHEME: SideQuests
      PROJECT: SideQuests.xcodeproj
      DERIVED_DATA: ${{ github.workspace }}/DerivedData
      ARCHIVE_PATH: ${{ github.workspace }}/SideQuests.xcarchive
      EXPORT_PATH: ${{ github.workspace }}/export

    steps:
      # ─── 1. Checkout ────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ─── 2. Select Xcode ────────────────────────────────────────────────────
      - name: Select latest stable Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      # ─── 3. Resolve SPM packages ────────────────────────────────────────────
      - name: Resolve Swift Package dependencies
        run: |
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -resolvePackageDependencies \
            -derivedDataPath "$DERIVED_DATA"

      # ─── 4. Build archive ───────────────────────────────────────────────────
      - name: Archive (unsigned)
        run: |
          xcodebuild archive \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -destination "generic/platform=macOS" \
            -derivedDataPath "$DERIVED_DATA" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"

      # ─── 5. Export .app from archive ────────────────────────────────────────
      - name: Export .app
        run: |
          mkdir -p "$EXPORT_PATH"
          # Copy .app directly from the archive (no signing required)
          APP=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" | head -1)
          cp -R "$APP" "$EXPORT_PATH/"
          echo "Exported: $APP"

      # ─── 6. Zip the .app bundle ─────────────────────────────────────────────
      - name: Zip app
        run: |
          cd "$EXPORT_PATH"
          APP=$(find . -name "*.app" | head -1 | sed 's|^\./||')
          zip -r --symlinks "../SideQuests.zip" "$APP"
          echo "Zipped: $APP → SideQuests.zip"

      # ─── 7. Upload artifact (always) ────────────────────────────────────────
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SideQuests-${{ github.sha }}
          path: SideQuests.zip
          retention-days: 30

      # ─── 8. Create GitHub Release on push to main ───────────────────────────
      - name: Get version tag
        id: version
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          echo "tag=v1.0-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Side Quests ${{ steps.version.outputs.tag }}"
          body: |
            ## Side Quests — Spotlight-style Discord launcher

            ### Install
            1. Download `SideQuests.zip` and unzip it.
            2. Move `Side Quests.app` to `/Applications`.
            3. Double-click to launch — grant Accessibility permissions when prompted.
            4. Press **⌘⇧Space** to open the launcher.

            > **Note**: This build is unsigned. macOS will block it on first launch.
            > Right-click → Open → Open to bypass Gatekeeper, or run:
            > ```
            > xattr -cr "/Applications/Side Quests.app"
            > ```

            Built from commit ${{ github.sha }}.
          files: SideQuests.zip
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
